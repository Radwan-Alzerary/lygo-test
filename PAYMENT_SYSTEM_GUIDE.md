# نظام استلام الأموال والدفع - دليل التطبيق

## نظرة عامة
تم تطوير نظام شامل لإدارة استلام الأموال من السائقين مع معالجة المبالغ الإضافية وحساب العمولات تلقائياً.

## تدفق النظام الجديد

### 1. إنهاء الرحلة
- عندما ينهي الكابتن الرحلة، تنتقل الرحلة لحالة `awaiting_payment`
- يتم إرسال طلب للكابتن لإدخال المبلغ المستلم
- الرحلة تبقى معلقة حتى يتم إدخال المبلغ

### 2. إدخال المبلغ المستلم
**Socket Event**: `submitPayment`
```javascript
socket.emit("submitPayment", {
  rideId: "ride_id_here",
  receivedAmount: 3000, // المبلغ الفعلي المستلم
  notes: "ملاحظات إضافية" // اختياري
});
```

### 3. معالجة الدفع
#### أ. المبلغ الصحيح (2500):
- يتم تسجيل الدفع كـ `full payment`
- تحديث حالة الرحلة لـ `completed`
- حساب العمولة وأرباح الكابتن

#### ب. المبلغ الإضافي (3000):
- يتم تسجيل الدفع كـ `full payment`
- المبلغ الإضافي (500) يُحول من محفظة الكابتن لمحفظة الزبون
- تحديث رصيد الزبون
- إشعار الزبون بالمبلغ المسترد

#### ج. المبلغ الناقص (2000):
- يتم تسجيل الدفع كـ `partial payment`
- تسجيل المبلغ الناقص (500)
- إكمال الرحلة مع ملاحظة النقص

## الحقول الجديدة

### Driver Model
```javascript
{
  balance: Number, // الرصيد الحالي
  totalEarnings: Number, // إجمالي الأرباح
  totalRides: Number, // إجمالي الرحل المكتملة
  rating: Number, // التقييم
  lastPaymentDate: Date // تاريخ آخر دفع
}
```

### Customer Model
```javascript
{
  walletBalance: Number, // رصيد المحفظة
  totalSpent: Number, // إجمالي المبالغ المدفوعة
  totalRides: Number // إجمالي الرحل
}
```

### User Model (Admin)
```javascript
{
  role: ["user", "admin", "driver", "captain", "moderator"],
  totalCommissions: Number, // إجمالي العمولات
  totalSystemEarnings: Number // إجمالي أرباح النظام
}
```

### Ride Model
```javascript
{
  status: [..., "awaiting_payment", ...], // حالة جديدة
  paymentStatus: [..., "waived"], // للرحل المعفاة من الدفع
}
```

## Socket Events

### للكابتن:
- `paymentRequired` - طلب إدخال المبلغ
- `paymentProcessed` - تأكيد معالجة الدفع
- `submitPayment` - إرسال المبلغ المستلم

### للزبون:
- `rideAwaitingPayment` - إشعار بانتظار تأكيد الدفع
- `rideCompleted` - إشعار بإكمال الرحلة مع تفاصيل الدفع

## API Endpoints

### 1. الرحل المعلقة
```http
GET /api/rides/pending-payment
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "message": "تم استرجاع الرحل المعلقة بنجاح",
  "data": {
    "pendingRides": [...],
    "count": 5
  }
}
```

### 2. إكمال رحلة بالقوة (للإدارة فقط)
```http
POST /api/rides/{rideId}/force-complete
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "reason": "سبب الإكمال بدون دفع"
}
```

## المعاملات المالية

### 1. تحويل المبالغ الإضافية
- من: `محفظة الكابتن`
- إلى: `محفظة الزبون`
- النوع: `dtc` (Driver to Customer)

### 2. تحويل العمولات
- من: `حساب الكابتن`
- إلى: `حساب الإدارة`
- النوع: `dtu` (Driver to Users/Admin)

### 3. حساب العمولة
- العمولة الافتراضية: `15%`
- رسوم المعالجة: قابلة للتكوين
- صافي أرباح الكابتن = المبلغ المستلم - العمولة - رسوم المعالجة

## مثال تطبيقي

### السيناريو: رحلة بتكلفة 2500 دينار

#### 1. الكابتن يستلم 3000 دينار:
```
- المبلغ المتوقع: 2500 د
- المبلغ المستلم: 3000 د
- العمولة (15%): 375 د
- أرباح الكابتن: 2125 د
- المبلغ الإضافي للزبون: 500 د
- رصيد الإدارة: +375 د
```

#### 2. الكابتن يستلم 2000 دينار:
```
- المبلغ المتوقع: 2500 د
- المبلغ المستلم: 2000 د
- المبلغ الناقص: 500 د
- العمولة (15%): 300 د
- أرباح الكابتن: 1700 د
- الحالة: partial payment
```

## الأمان والتحقق

### 1. التحقق من الصلاحيات
- الكابتن: يمكنه فقط إدخال دفعات رحلاته
- الزبون: يرى فقط رحلاته المعلقة
- الإدارة: تستطيع رؤية جميع الرحل المعلقة

### 2. التحقق من الرصيد
- التأكد من وجود رصيد كافي في محفظة الكابتن للمبالغ الإضافية
- تسجيل جميع المعاملات في قاعدة البيانات

### 3. معالجة الأخطاء
- في حالة فشل التحويل، يتم الاحتفاظ بسجل الدفع
- رسائل خطأ واضحة للكابتن والزبون
- تسجيل مفصل في الـ logs

## الاختبار

### 1. اختبار Socket Connection:
```javascript
// الاتصال ككابتن
const socket = io('http://localhost:5230/captain');

// إرسال دفعة
socket.emit('submitPayment', {
  rideId: 'ride_id',
  receivedAmount: 3000
});
```

### 2. اختبار API:
```bash
# جلب الرحل المعلقة
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:5230/api/rides/pending-payment
```

## الملاحظات المهمة

1. **الرحل المعلقة**: تبقى الرحلة في حالة `awaiting_payment` حتى يتم إدخال المبلغ
2. **المبالغ الإضافية**: يتم تحويلها فوراً للزبون
3. **العمولات**: يتم حسابها وتحويلها تلقائياً للإدارة
4. **التتبع**: جميع المعاملات مسجلة ومتتبعة
5. **الأمان**: التحقق من الصلاحيات في كل عملية

## التطوير المستقبلي

- [ ] إضافة إشعارات push للرحل المعلقة
- [ ] نظام تذكير للكابتن بالرحل غير المدفوعة
- [ ] تقارير مالية تفصيلية للإدارة
- [ ] نظام خصومات وعروض خاصة
